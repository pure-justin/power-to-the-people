#!/usr/bin/env node
/**
 * Upload utility rates data to Firestore solar_utility_rates collection.
 * Reads from data/utility_rates/all_utilities.json (3,500+ utilities)
 * and per-state files for state summaries.
 *
 * Data sources: EIA-861 (2024), OpenEI URDB, DSIRE
 * Generated by: scripts/fetchUtilityRates.cjs
 */

const admin = require("firebase-admin");
const fs = require("fs");
const path = require("path");

// Initialize with service account
const serviceAccount = require("../firebase-service-account.json");
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  projectId: "power-to-the-people-vpp",
});

const db = admin.firestore();

async function main() {
  // Load new comprehensive data
  const dataFile = path.join(
    __dirname,
    "../data/utility_rates/all_utilities.json",
  );
  if (!fs.existsSync(dataFile)) {
    console.error("Data file not found. Run scripts/fetchUtilityRates.cjs first.");
    process.exit(1);
  }
  const raw = JSON.parse(fs.readFileSync(dataFile, "utf8"));
  const utilities = raw.utilities;

  console.log(
    `Uploading ${utilities.length} utilities to Firestore solar_utility_rates...`,
  );

  const collection = db.collection("solar_utility_rates");
  const batchSize = 400; // Firestore batch limit is 500
  let totalWritten = 0;

  for (let i = 0; i < utilities.length; i += batchSize) {
    const chunk = utilities.slice(i, i + batchSize);
    const batch = db.batch();

    for (const util of chunk) {
      // Use state + utility_id as document ID for easy lookups
      const docId = `${util.state}_${util.utility_id}`;
      const docRef = collection.doc(docId);

      batch.set(docRef, {
        utility_id: util.utility_id,
        utility_name: util.utility_name,
        state: util.state,
        state_name: util.state_name || util.state,
        ownership_type: util.ownership_type || "unknown",
        customer_count: util.customer_count || 0,
        residential_rate_per_kwh: util.residential_rate_per_kwh || 0,
        rate_data_source: util.rate_data_source || "EIA-861",
        rate_structure: util.rate_structure || "unknown",
        tou_available: util.tou_available || false,
        demand_charges: util.demand_charges || false,
        has_net_metering: util.has_net_metering || false,
        net_metering_type: util.net_metering_type || "unknown",
        net_metering_note: util.net_metering_note || null,
        solar_installations: util.solar_installations || 0,
        solar_capacity_mw: util.solar_capacity_mw || 0,
        urdb_rate_name: util.urdb_rate_name || null,
        urdb_rate_per_kwh: util.urdb_rate_per_kwh || null,
        updated_at: util.updated_at,
        source: "EIA-861 + OpenEI URDB + DSIRE",
        imported_at: admin.firestore.FieldValue.serverTimestamp(),
      });
    }

    await batch.commit();
    totalWritten += chunk.length;
    console.log(
      `  Batch ${Math.floor(i / batchSize) + 1}: wrote ${chunk.length} docs (${totalWritten}/${utilities.length})`,
    );
  }

  // Upload state-level summary docs
  console.log("\nUploading state summary documents...");
  const ratesDir = path.join(__dirname, "../data/utility_rates");
  const stateFiles = fs
    .readdirSync(ratesDir)
    .filter((f) => /^[A-Z]{2}\.json$/.test(f));

  // May need multiple batches for 51 states
  const stateBatch = db.batch();
  for (const stateFile of stateFiles) {
    const stateCode = stateFile.replace(".json", "");
    const stateData = JSON.parse(
      fs.readFileSync(path.join(ratesDir, stateFile), "utf8"),
    );

    const docRef = collection.doc(`_state_${stateCode}`);
    stateBatch.set(docRef, {
      _type: "state_summary",
      state: stateCode,
      state_name: stateData.state_name || stateCode,
      utility_count: stateData.utility_count,
      total_residential_customers: stateData.total_residential_customers || 0,
      avg_residential_rate: stateData.avg_residential_rate,
      net_metering_policy: stateData.net_metering_policy || {},
      total_solar_installations: stateData.total_solar_installations || 0,
      total_solar_capacity_mw: stateData.total_solar_capacity_mw || 0,
      updated_at: stateData.generated_at || new Date().toISOString(),
      imported_at: admin.firestore.FieldValue.serverTimestamp(),
    });
  }
  await stateBatch.commit();
  console.log(`  Wrote ${stateFiles.length} state summary docs`);

  console.log(
    `\nDone! ${totalWritten} utility docs + ${stateFiles.length} state summaries uploaded to solar_utility_rates`,
  );
  console.log(`\nData summary:`);
  console.log(`  Total utilities: ${raw.total_utilities}`);
  console.log(`  States covered: ${raw.states_covered}`);
  console.log(`  National avg rate: $${raw.national_avg_rate}/kWh`);
  console.log(`  Weighted avg rate: $${raw.weighted_avg_rate}/kWh`);
  process.exit(0);
}

main().catch((err) => {
  console.error("Upload failed:", err);
  process.exit(1);
});
