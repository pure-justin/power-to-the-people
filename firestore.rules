rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isInstaller() {
      return isSignedIn() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'installer';
    }

    function isAdminOrInstaller() {
      return isAdmin() || isInstaller();
    }

    // LEADS COLLECTION
    match /leads/{leadId} {
      // Anyone can create a lead (public form submission)
      allow create: if true;

      // Users can read their own leads (by email)
      allow read: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        resource.data.email == request.auth.token.email
      );

      // Admins and sales reps can read all leads
      allow read: if isAdminOrInstaller();

      // Admins can write all leads
      allow write: if isAdmin();

      // Assigned sales reps can update their leads (status, notes)
      allow update: if isSignedIn() &&
                       resource.data.assignedTo == request.auth.uid &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'notes', 'updatedAt', 'lastContactedAt',
                                   'qualifiedAt', 'closedAt', 'score', 'scoreBreakdown']);
    }

    // PROJECTS COLLECTION
    match /projects/{projectId} {
      // Anyone authenticated can create
      allow create: if isSignedIn();

      // Users can read their own projects
      allow read: if isSignedIn();

      // Admins can read/write all
      allow read, write: if isAdmin();

      // Tasks subcollection
      match /tasks/{taskId} {
        allow read: if isSignedIn();
        allow create: if isAdminOrInstaller();
        allow update: if isAdminOrInstaller();
        allow delete: if isAdmin();
      }
    }

    // ADDRESS CACHE COLLECTION
    match /addressCache/{addressHash} {
      // Anyone can read cache
      allow read: if true;

      // Only authenticated users can write cache
      allow write: if isSignedIn();

      // Admins can delete cache entries
      allow delete: if isAdmin();
    }

    // USERS COLLECTION
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);

      // Users can update their own profile (limited fields)
      allow update: if isOwner(userId) &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['displayName', 'firstName', 'lastName', 'phone',
                                   'notifications', 'updatedAt', 'lastLoginAt']);

      // Admins can read/write all user profiles
      allow read, write: if isAdmin();

      // Allow user creation during signup
      allow create: if isOwner(userId) &&
                       request.resource.data.email == request.auth.token.email;

      // Private subcollection for SMT credentials
      match /private/smt {
        // Only the user can read/write their own credentials
        allow read, write: if isOwner(userId);

        // Cloud Functions can access (using admin SDK)
      }
    }

    // ADMIN ANALYTICS COLLECTION
    match /analytics/{document=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // SYSTEM CONFIGURATION
    match /config/{document=**} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // REFERRALS COLLECTION
    match /referrals/{userId} {
      // Users can read and write their own referral record
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) || isAdmin();
      allow create: if isSignedIn();
    }

    // REFERRAL TRACKING COLLECTION
    match /referralTracking/{trackingId} {
      // Users can read their own referred customers
      allow read: if isSignedIn() &&
                    (resource.data.referrerId == request.auth.uid || isAdmin());
      // Only admins can update referral status
      allow update: if isAdmin();
      // Allow creation during signup (even anonymous users for tracking)
      allow create: if true;
    }

    // REFERRAL CLICKS (Analytics)
    match /referralClicks/{clickId} {
      allow read: if isSignedIn();
      // Allow anonymous click tracking
      allow write: if true;
    }

    // PENDING NOTIFICATIONS (Email queue)
    match /pendingNotifications/{notificationId} {
      allow read, write: if isAdmin();
    }

    // PAYOUTS COLLECTION
    match /payouts/{payoutId} {
      allow read: if isSignedIn() &&
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    // COMMERCIAL LEADS COLLECTION (Cold Outbound Campaign)
    match /commercial_leads/{leadId} {
      // Admins have full access
      allow read, write: if isAdmin();

      // Sales team can read and update engagement
      allow read: if isSignedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sales', 'installer'];

      allow update: if isSignedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sales'] &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['engagement', 'status', 'notes', 'updatedAt', 'propertyManager']);
    }

    // CAMPAIGNS COLLECTION
    match /campaigns/{campaignId} {
      // Admins have full access
      allow read, write: if isAdmin();

      // Sales team can read
      allow read: if isSignedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sales', 'installer'];
    }

    // UTILITY RATES COLLECTION (cached data)
    match /utility_rates/{utilityId} {
      // Public read access
      allow read: if true;

      // Admin write
      allow write: if isAdmin();
    }

    // EMAIL TEMPLATES COLLECTION
    match /email_templates/{templateId} {
      // Public read
      allow read: if true;

      // Admin write
      allow write: if isAdmin();
    }

    // SMS LOG COLLECTION
    match /smsLog/{logId} {
      // Only admins can read SMS logs
      allow read: if isAdmin();

      // Cloud Functions can write (via Admin SDK)
      // Direct writes from client are blocked
      allow write: if false;
    }

    // SOLAR DATA COLLECTIONS (nationwide equipment, rates, incentives, permits)
    match /solar_equipment/{docId} {
      allow read: if true; // Public read - equipment data is not sensitive
      allow write: if isAdmin();
    }

    match /solar_utility_rates/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /solar_incentives/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /solar_permits/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /solar_tpo_providers/{docId} {
      allow read: if isSignedIn(); // TPO data requires auth
      allow write: if isAdmin();
    }

    match /solar_finance_products/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // DATA REFRESH LOG
    match /data_refresh_log/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only via Admin SDK
    }

    // SUBSCRIPTIONS (from universal-payments)
    match /subscriptions/{subscriptionId} {
      allow read: if isSignedIn() &&
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if false;
    }

    // USAGE RECORDS (metered billing)
    match /usage_records/{recordId} {
      allow read: if isSignedIn() &&
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false; // Cloud Functions only via Admin SDK
    }

    // AVA CONVERSATIONS (messaging between Ava and Justin)
    match /ava_conversations/{conversationId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();

      match /messages/{messageId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn(); // mark as read
        allow delete: if false;
      }
    }

    // API KEYS COLLECTION
    match /apiKeys/{keyId} {
      allow read: if isSignedIn() &&
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn();
      allow update: if isSignedIn() &&
                      resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }

    // INVOICES COLLECTION (Mercury ACH payments)
    match /invoices/{invoiceId} {
      // Admins have full access
      allow read, write: if isAdmin();

      // Customers can read their own invoices (by email match)
      allow read: if isSignedIn() &&
                    resource.data.customerEmail == request.auth.token.email;

      // No direct client writes - Cloud Functions only
    }

    // MARKETPLACE LISTINGS
    match /marketplace_listings/{listingId} {
      allow read: if isSignedIn();
      allow create: if isAdminOrInstaller();
      allow update: if isAdminOrInstaller();
      allow delete: if isAdmin();
    }

    // MARKETPLACE BIDS
    match /marketplace_bids/{bidId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (resource.data.bidder.userId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }

    // WORKERS (marketplace profiles)
    match /workers/{workerId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (resource.data.user_id == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }

    // MARKETPLACE SERVICES (service type catalog)
    match /marketplace_services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // MARKETPLACE RATINGS
    match /marketplace_ratings/{ratingId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isAdmin();
    }

    // =====================================================
    // SOLAROS PIPELINE COLLECTIONS (Phase 0-9)
    // =====================================================

    // AI TASK ENGINE — Core AI-first/human-fallback system
    // Cloud Functions handle all writes via Admin SDK.
    // Frontend reads for dashboard display.
    match /ai_tasks/{taskId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    // AI LEARNINGS — Patterns captured from human completions
    match /ai_learnings/{learningId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    // AHJ REGISTRY — Authority Having Jurisdiction database
    match /ahj_registry/{ahjId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // PERMIT SOPS — Standard operating procedures per AHJ
    match /permit_sops/{sopId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // SITE SURVEYS — Customer/installer site survey data
    match /site_surveys/{surveyId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        resource.data.customerId == request.auth.uid || isAdminOrInstaller()
      );
      allow delete: if isAdmin();
    }

    // EAGLEVIEW REPORTS — Automated roof measurement data
    match /eagleview_reports/{reportId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    // CAD DESIGNS — Auto-generated system designs
    match /cad_designs/{designId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only (human edits go through onCall)
    }

    // PERMITS — Permit lifecycle tracking
    match /permits/{permitId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    // SCHEDULE SLOTS — Installer availability
    match /schedule_slots/{slotId} {
      allow read: if isSignedIn();
      allow create: if isAdminOrInstaller();
      allow update: if isAdminOrInstaller();
      allow delete: if isAdmin();
    }

    // INSTALL SCHEDULES — Confirmed installation appointments
    match /install_schedules/{scheduleId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    // INSTALL PHOTOS — Phase-by-phase install QC photos
    match /install_photos/{photoSetId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only (uploads go through onCall)
    }

    // FUNDING PACKAGES — Funding/financing lifecycle
    match /funding_packages/{packageId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    // BANKABILITY PACKAGES — PPA/lease bankable documentation
    match /bankability_packages/{packageId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    // TAX CREDIT AUDITS — Credit verification and certification
    match /tax_credit_audits/{auditId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    // TAX CREDIT INSURANCE — Risk assessment and coverage
    match /tax_credit_insurance/{insuranceId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    // TAX CREDIT LISTINGS — Marketplace listings (public read for search)
    match /tax_credit_listings/{listingId} {
      allow read: if true; // Public marketplace browsing
      allow write: if false; // Cloud Functions only (offers go through onCall)
    }

    // TAX CREDIT TRANSACTIONS — Completed credit transfers
    match /tax_credit_transactions/{transactionId} {
      allow read: if isSignedIn() && (
        resource.data.sellerId == request.auth.uid ||
        resource.data.buyerId == request.auth.uid ||
        isAdmin()
      );
      allow write: if false; // Cloud Functions only
    }

    // DOCUMENTS — Proposals, contracts, permits, completion certificates
    // Generated by documentService.ts (replaces PandaDoc)
    match /documents/{documentId} {
      allow read: if isSignedIn() && (
        resource.data.projectId != null || isAdmin()
      );
      allow write: if false; // Cloud Functions only (generate, send, sign via onCall)
    }

    // DOCUMENT TEMPLATES — Admin-managed templates for proposals, contracts, etc.
    match /document_templates/{templateId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
