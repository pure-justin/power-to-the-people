rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isInstaller() {
      return isSignedIn() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'installer';
    }

    function isAdminOrInstaller() {
      return isAdmin() || isInstaller();
    }

    // LEADS COLLECTION
    match /leads/{leadId} {
      // Anyone can create a lead (public form submission)
      allow create: if true;

      // Users can read their own leads (by email)
      allow read: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        resource.data.email == request.auth.token.email
      );

      // Admins and sales reps can read all leads
      allow read: if isAdminOrInstaller();

      // Admins can write all leads
      allow write: if isAdmin();

      // Assigned sales reps can update their leads (status, notes)
      allow update: if isSignedIn() &&
                       resource.data.assignedTo == request.auth.uid &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'notes', 'updatedAt', 'lastContactedAt',
                                   'qualifiedAt', 'closedAt', 'score', 'scoreBreakdown']);
    }

    // PROJECTS COLLECTION (Legacy - keep for backward compatibility)
    match /projects/{projectId} {
      // Anyone authenticated can create
      allow create: if isSignedIn();

      // Users can read their own projects
      allow read: if isSignedIn();

      // Admins can read/write all
      allow read, write: if isAdmin();
    }

    // ADDRESS CACHE COLLECTION
    match /addressCache/{addressHash} {
      // Anyone can read cache
      allow read: if true;

      // Only authenticated users can write cache
      allow write: if isSignedIn();

      // Admins can delete cache entries
      allow delete: if isAdmin();
    }

    // USERS COLLECTION
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);

      // Users can update their own profile (limited fields)
      allow update: if isOwner(userId) &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['displayName', 'firstName', 'lastName', 'phone',
                                   'notifications', 'updatedAt', 'lastLoginAt']);

      // Admins can read/write all user profiles
      allow read, write: if isAdmin();

      // Allow user creation during signup
      allow create: if isOwner(userId) &&
                       request.resource.data.email == request.auth.token.email;

      // Private subcollection for SMT credentials
      match /private/smt {
        // Only the user can read/write their own credentials
        allow read, write: if isOwner(userId);

        // Cloud Functions can access (using admin SDK)
      }
    }

    // ADMIN ANALYTICS COLLECTION
    match /analytics/{document=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // SYSTEM CONFIGURATION
    match /config/{document=**} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // REFERRALS COLLECTION
    match /referrals/{userId} {
      // Users can read and write their own referral record
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) || isAdmin();
      allow create: if isSignedIn();
    }

    // REFERRAL TRACKING COLLECTION
    match /referralTracking/{trackingId} {
      // Users can read their own referred customers
      allow read: if isSignedIn() &&
                    (resource.data.referrerId == request.auth.uid || isAdmin());
      // Only admins can update referral status
      allow update: if isAdmin();
      // Allow creation during signup (even anonymous users for tracking)
      allow create: if true;
    }

    // REFERRAL CLICKS (Analytics)
    match /referralClicks/{clickId} {
      allow read: if isSignedIn();
      // Allow anonymous click tracking
      allow write: if true;
    }

    // PENDING NOTIFICATIONS (Email queue)
    match /pendingNotifications/{notificationId} {
      allow read, write: if isAdmin();
    }

    // PAYOUTS COLLECTION
    match /payouts/{payoutId} {
      allow read: if isSignedIn() &&
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    // COMMERCIAL LEADS COLLECTION (Cold Outbound Campaign)
    match /commercial_leads/{leadId} {
      // Admins have full access
      allow read, write: if isAdmin();

      // Sales team can read and update engagement
      allow read: if isSignedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sales', 'installer'];

      allow update: if isSignedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sales'] &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['engagement', 'status', 'notes', 'updatedAt', 'propertyManager']);
    }

    // CAMPAIGNS COLLECTION
    match /campaigns/{campaignId} {
      // Admins have full access
      allow read, write: if isAdmin();

      // Sales team can read
      allow read: if isSignedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sales', 'installer'];
    }

    // UTILITY RATES COLLECTION (cached data)
    match /utility_rates/{utilityId} {
      // Public read access
      allow read: if true;

      // Admin write
      allow write: if isAdmin();
    }

    // EMAIL TEMPLATES COLLECTION
    match /email_templates/{templateId} {
      // Public read
      allow read: if true;

      // Admin write
      allow write: if isAdmin();
    }

    // SMS LOG COLLECTION
    match /smsLog/{logId} {
      // Only admins can read SMS logs
      allow read: if isAdmin();

      // Cloud Functions can write (via Admin SDK)
      // Direct writes from client are blocked
      allow write: if false;
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
